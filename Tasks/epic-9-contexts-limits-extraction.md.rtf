{\rtf1\ansi\ansicpg1252\cocoartf2867
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fswiss\fcharset0 Helvetica;}
{\colortbl;\red255\green255\blue255;}
{\*\expandedcolortbl;;}
\margl1440\margr1440\vieww11520\viewh8400\viewkind0
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural\partightenfactor0

\f0\fs24 \cf0 # Epic 9: Custom Contexts, Configurable Limits & URL Extraction\
\
## Overview\
\
Expand ThoughtFolio from global 10-thought limit to contextual organization with Active List. Add URL-based thought extraction.\
\
**PRD:** See `Claude Context/PRD.md`\
**Database:** Migration SQL has been run in Supabase\
\
## Current State\
\
- \uc0\u9989  Database migration complete (contexts table, gems columns, triggers)\
- \uc0\u10060  Types not updated\
- \uc0\u10060  API routes not created\
- \uc0\u10060  UI not updated\
- \uc0\u10060  URL extraction not implemented\
\
## Tasks\
\
### Phase 1: Foundation (Types & API)\
\
#### 1.0 Update Type Definitions (traces to: FR-1.1, FR-3.1)\
- [ ] 1.1 Create `lib/types/context.ts` with Context interface\
- [ ] 1.2 Update `lib/types/thought.ts` to include `context_id`, `is_on_active_list`\
- [ ] 1.3 Keep `ContextTag` as deprecated alias for backwards compat\
- [ ] 1.4 Add `MAX_ACTIVE_LIST = 10` constant\
- [ ] 1.5 Update imports across codebase\
\
#### 2.0 Create Context Service (traces to: FR-1.1 through FR-1.8)\
- [ ] 2.1 Create `lib/contexts.ts` with CRUD functions:\
  - `getContexts()` \'97 list with thought counts\
  - `getContextBySlug(slug)` \'97 single context\
  - `createContext(input)` \'97 create custom\
  - `updateContext(id, input)` \'97 update name/color/limit\
  - `deleteContext(id)` \'97 delete, move thoughts to "Other"\
  - `getContextThoughtCount(contextId)` \'97 count\
- [ ] 2.2 Add validation: unique names, max 50 chars, can't delete defaults\
- [ ] 2.3 Write unit tests\
\
#### 3.0 Create Context API Routes (traces to: FR-1.1 through FR-1.8)\
- [ ] 3.1 Create `app/api/contexts/route.ts` (GET, POST)\
- [ ] 3.2 Create `app/api/contexts/[id]/route.ts` (GET, PUT, DELETE)\
- [ ] 3.3 Add error handling and validation\
- [ ] 3.4 Test API routes\
\
#### 4.0 Update Thought Service for Active List (traces to: FR-3.1 through FR-3.5)\
- [ ] 4.1 Update `lib/thoughts.ts` for `context_id` and `is_on_active_list`\
- [ ] 4.2 Add `toggleActiveList(thoughtId)` with limit check\
- [ ] 4.3 Add `getActiveListCount()` function\
- [ ] 4.4 Update `createMultipleThoughts()` for `context_id`\
- [ ] 4.5 Update daily prompt query: filter `is_on_active_list = true`\
- [ ] 4.6 Verify Moments queries ALL thoughts (no filter change)\
\
### Phase 2: Settings UI\
\
#### 5.0 Context Management UI (traces to: US-1)\
- [ ] 5.1 Create `components/settings/ContextSettings.tsx`\
  - List contexts with counts\
  - Add/edit/delete actions\
- [ ] 5.2 Create `components/settings/ContextForm.tsx`\
- [ ] 5.3 Add color picker (preset colors)\
- [ ] 5.4 Integrate into `app/settings/page.tsx`\
- [ ] 5.5 Test CRUD in UI\
\
### Phase 3: Thought UI Updates\
\
#### 6.0 Update Thought Creation (traces to: FR-2.4, FR-2.5)\
- [ ] 6.1 Update `components/gems/gem-form.tsx` \'97 context dropdown from API\
- [ ] 6.2 Update `components/extract-gems-modal.tsx` \'97 context dropdown\
- [ ] 6.3 Show per-context limit ("Coding: 12/20")\
- [ ] 6.4 Block creation if context full\
\
#### 7.0 Update Thought Cards & List (traces to: FR-3.3, FR-3.4, FR-3.5)\
- [ ] 7.1 Add Active badge to `components/gems/gem-card.tsx`\
- [ ] 7.2 Add toggle Active action button\
- [ ] 7.3 Show context badge (colored)\
- [ ] 7.4 Add filter tabs: All / Active / Passive\
- [ ] 7.5 Add context filter dropdown\
- [ ] 7.6 Show Active count ("Active: 7/10")\
\
#### 8.0 Update Thought Detail (traces to: US-1, FR-3.3)\
- [ ] 8.1 Show context on detail page\
- [ ] 8.2 Add Active toggle\
- [ ] 8.3 Allow changing context\
\
### Phase 4: URL Extraction\
\
#### 9.0 Article Extraction Backend (traces to: FR-6.2 through FR-6.9)\
- [ ] 9.1 Install `@mozilla/readability` and `jsdom`\
- [ ] 9.2 Create `lib/url-extractor.ts`:\
  - `detectUrlType(url)` \'97 'article' | 'youtube' | 'unknown'\
  - `extractArticleContent(url)` \'97 fetch + Readability\
  - `extractYouTubeTranscript(url)` \'97 transcript API\
- [ ] 9.3 Create `app/api/extract/url/route.ts`\
- [ ] 9.4 Add 10 second timeout\
- [ ] 9.5 Error handling for paywalls, 404s\
- [ ] 9.6 Write tests\
\
#### 10.0 YouTube Extraction (traces to: FR-6.5)\
- [ ] 10.1 Install `youtube-transcript`\
- [ ] 10.2 Implement transcript extraction\
- [ ] 10.3 Handle "no transcript" gracefully\
- [ ] 10.4 Extract video title for source\
- [ ] 10.5 Test with various URLs\
\
#### 11.0 URL Extraction UI (traces to: FR-6.2, FR-6.6, FR-6.7)\
- [ ] 11.1 Update `components/extract-gems-modal.tsx`:\
  - Tab 1: "Paste Text" (existing)\
  - Tab 2: "From URL" (new)\
- [ ] 11.2 URL input with Extract button\
- [ ] 11.3 Loading state\
- [ ] 11.4 Error with manual paste fallback\
- [ ] 11.5 Pre-populate suggested context\
- [ ] 11.6 End-to-end test\
\
### Phase 5: Polish\
\
#### 12.0 Update AI Prompts (traces to: FR-6.8)\
- [ ] 12.1 Update extraction prompt to suggest context\
- [ ] 12.2 Add context to response type\
- [ ] 12.3 Test suggestions\
\
#### 13.0 Documentation\
- [ ] 13.1 Update ARCHITECTURE.md (done via this epic)\
- [ ] 13.2 Update type definitions in docs\
\
#### 14.0 Testing & Verification\
- [ ] 14.1 Test context CRUD\
- [ ] 14.2 Test Active List limit (10)\
- [ ] 14.3 Test per-context limit\
- [ ] 14.4 Test URL extraction (Substack, Medium, blogs)\
- [ ] 14.5 Test YouTube extraction\
- [ ] 14.6 Test daily prompts = Active only\
- [ ] 14.7 Test Moments = all thoughts\
- [ ] 14.8 Verify migration data correct\
\
## Relevant Files\
\
### Types\
- `lib/types/thought.ts` \'97 update\
- `lib/types/context.ts` \'97 create\
\
### Services\
- `lib/contexts.ts` \'97 create\
- `lib/thoughts.ts` \'97 update\
- `lib/url-extractor.ts` \'97 create\
- `lib/ai/gemini.ts` \'97 update prompts\
\
### API Routes\
- `app/api/contexts/route.ts` \'97 create\
- `app/api/contexts/[id]/route.ts` \'97 create\
- `app/api/extract/url/route.ts` \'97 create\
\
### Components\
- `components/settings/ContextSettings.tsx` \'97 create\
- `components/settings/ContextForm.tsx` \'97 create\
- `components/gems/gem-card.tsx` \'97 update\
- `components/gems/gem-form.tsx` \'97 update\
- `components/extract-gems-modal.tsx` \'97 update\
\
### Pages\
- `app/settings/page.tsx` \'97 update\
- `app/gems/page.tsx` \'97 update\
- `app/gems/[id]/page.tsx` \'97 update\
\
## Acceptance Criteria\
\
- [ ] User can create, edit, delete custom contexts\
- [ ] Default contexts cannot be deleted\
- [ ] Each context shows thought count vs limit\
- [ ] User can toggle thoughts on/off Active List\
- [ ] Active List capped at 10 (enforced)\
- [ ] Daily prompts only show Active thoughts\
- [ ] Moments searches all thoughts, all contexts\
- [ ] User can extract from article URLs\
- [ ] User can extract from YouTube (when transcript available)\
- [ ] Graceful fallback when extraction fails\
- [ ] All existing data works after migration\
\
## Notes for Claude Code\
\
1. **Database migration already done** \'97 use new columns, don't create migration\
2. **Backwards compatibility** \'97 keep `context_tag` working during transition\
3. **Active List \uc0\u8800  status** \'97 thought can be `status: active` but `is_on_active_list: false`\
4. **Test with real URLs** \'97 Substack, Medium, dev.to, YouTube\
5. **Check Linear** \'97 create issues for phases if needed\
```\
\
---\
\
## Summary\
\
| File | Action |\
|------|--------|\
| `Claude Context/CLAUDE.md` | Replace entirely |\
| `Claude Context/PRODUCT-BRIEF.md` | Replace entirely |\
| `Claude Context/PRD.md` | Replace entirely |\
| `Claude Context/ARCHITECTURE.md` | Replace entirely |\
| `Claude Context/DECISIONS.md` | Replace entirely |\
| `Claude Context/STANDARDS.md` | Replace entirely |\
| **Supabase SQL Editor** | Run migration SQL |\
| `tasks/epic-9-contexts-limits-extraction.md` | Create new file |\
\
---\
\
## Handoff Prompt for Claude Code\
\
After running the SQL migration and copying files:\
```\
Read Claude Context/CLAUDE.md for project context.\
Then work on tasks/epic-9-contexts-limits-extraction.md \'97 start with Phase 1, task 1.0.\
Create a feature branch and commit after each completed parent task (1.0, 2.0, etc.).}